const http=axios.create({baseURL:baseURL,headers:{"x-csrf-token":window.yii.getCsrfToken()}});http.interceptors.request.use(function(t){return t},function(t){return Promise.reject(t)}),http.interceptors.response.use(function(t){return _.get(t,"data",t)},function(t){return Promise.reject(_.get(t,"response.data",t))});const socket=io(window.socketBaseURL,{transports:["websocket","polling"],forceNew:!0,path:window.socketPath});socket.on("connect",()=>{app.getClientIP()}).on("disconnect",t=>{"io server disconnect"===t&&socket.connect()}).on("setting",t=>{window.location.reload()});const SMARTCARD_EVENTS={PCSC_INITIAL:"PCSC_INITIAL",PCSC_CLOSE:"PCSC_CLOSE",DEVICE_WAITING:"DEVICE_WAITING",DEVICE_CONNECTED:"DEVICE_CONNECTED",DEVICE_ERROR:"DEVICE_ERROR",DEVICE_DISCONNECTED:"DEVICE_DISCONNECTED",CARD_INSERTED:"CARD_INSERTED",CARD_REMOVED:"CARD_REMOVED",READING_INIT:"READING_INIT",READING_START:"READING_START",READING_PROGRESS:"READING_PROGRESS",READING_COMPLETE:"READING_COMPLETE",READING_FAIL:"READING_FAIL"};var app=new Vue({el:"#app",data:{message:"Hello Vue!",action:"",loading:!1,loading2:!1,loadingMsg:"กรุณาเสียบบัตรประชาชน",crsfToken:"",clientIP:"0.0.0.0",search:"",patient:null,right:null,httpConfig:{baseURL:window.nodeBaseURL},service_id:null,services:[]},computed:{patientName:function(){if("scan-idcard"===this.action&&this.patient)return _.get(this.patient,"fullname","ชื่อ-นามสกุล");if("hn-or-idcard"===this.action&&this.right){const t=_.get(this.right,"title_name",""),e=_.get(this.right,"fname",""),i=_.get(this.right,"lname","");return`${t}${e} ${i}`}return"ชื่อ-นามสกุล"},hn:function(){return _.get(this.patient,"hn","-")},cid:function(){return"scan-idcard"===this.action&&this.patient?_.get(this.patient,"citizenId",""):"hn-or-idcard"===this.action&&this.right?_.get(this.right,"person_id",""):""},cidFormat:function(){return"scan-idcard"===this.action&&this.patient?String(_.get(this.patient,"citizenId","")).substr(0,9)+"XXXX":"hn-or-idcard"===this.action&&this.right?String(_.get(this.right,"person_id","")).substr(0,9)+"XXXX":"-"},rightName:function(){return _.get(this.right,"maininscl_name","-")},avatar:function(){return _.get(this.patient,"photo",window.patientPicture)},age:function(){if("scan-idcard"===this.action&&this.patient){const[t,e,i]=String(this.patient.birthday).split("-"),n=moment(),s=moment(`${parseInt(t)}-${e}-${i}`,"YYYY-MM-DD"),o=n.diff(s,"year");return s.add(o,"years"),o}if("hn-or-idcard"===this.action&&this.right){const t=parseInt(this.right.birthdate.substr(0,4))-543,e=this.right.birthdate.substr(4,2),i=this.right.birthdate.substr(6),n=moment(),s=moment(`${parseInt(t)}-${e}-${i}`,"YYYY-MM-DD"),o=n.diff(s,"year");return s.add(o,"years"),o}return 0},disabledStyle:function(){return this.service_id?{}:{cursor:"not-allowed",pointerEvents:"none"}},opacity:function(){return this.service_id?null:.65}},beforeMount(){this.crsfToken=window.yii.getCsrfToken()},mounted(){this.$nextTick(function(){this.fetchDataServices()})},watch:{action:function(t,e){"hn-or-idcard"===t&&setTimeout(()=>{$("#input-hn-or-idcard").focus()},100)},search:function(t,e){13===String(t).length&&this.onConfirmSearch()}},methods:{getClientIP:async function(){try{const t=await http.get("/api2/v1/kiosk/client-ip");this.clientIP=t,this.onSmartCardHandler()}catch(t){Swal.fire({icon:"error",title:"Oops...",text:t.message})}},fetchDataServices:async function(){try{const t=await http.get("/api2/v1/kiosk/services");this.services=t}catch(t){Swal.fire({icon:"error",title:"Oops...",text:t.message})}},onSmartCardHandler:function(){const t=this;socket.on(SMARTCARD_EVENTS.DEVICE_CONNECTED,e=>{_.get(e,"ipAddress")===t.clientIP&&(t.setRight(null),t.setProfile(null),t.setLoadingMessage("อุปกรณ์กำลังเชื่อมต่อ..."),setTimeout(()=>{t.setLoadingMessage("กรุณาเสียบบัตรประชาชน")},1500))}),socket.on(SMARTCARD_EVENTS.CARD_INSERTED,e=>{_.get(e,"ipAddress")===t.clientIP&&(t.setRight(null),t.setProfile(null),t.setLoadingMessage("เสียบบัตร"),setTimeout(()=>{t.setLoadingMessage("กรุณารอสักครู่...")},1e3))}),socket.on(SMARTCARD_EVENTS.CARD_REMOVED,e=>{_.get(e,"ipAddress")===t.clientIP&&(t.setRight(null),t.setProfile(null),t.setLoading(!1),t.setLoadingMessage("กรุณาเสียบบัตรประชาชน"))}),socket.on(SMARTCARD_EVENTS.READING_START,e=>{_.get(e,"ipAddress")===t.clientIP&&(t.setRight(null),t.setProfile(null),t.setLoading(!0),t.setLoadingMessage("กำลังอ่านข้อมูลบัตร..."))}),socket.on(SMARTCARD_EVENTS.READING_COMPLETE,e=>{_.get(e,"ipAddress")===t.clientIP&&t.decryptData(_.get(e,"data.encrypted"))}),socket.on(SMARTCARD_EVENTS.READING_FAIL,e=>{_.get(e,"ipAddress")===t.clientIP&&(t.setRight(null),t.setProfile(null),t.setLoading(!1),t.setLoadingMessage("กรุณาเสียบบัตรประชาชน"))})},setLoading:function(t=!1){this.loading=t},setLoadingMessage:function(t=""){this.loadingMsg=t},init:function(){this.getClientIP()},onSelectAction:function(t){this.action=t},onCancelAction:function(){this.action="",this.search="",this.loading=!1,this.loading2=!1,this.loadingMsg="กรุณาเสียบบัตรประชาชน",this.service_id=null,this.setRight(null),this.setProfile(null)},decryptData:async function(t){const e=this;if(!this.loading2)try{e.loading2=!0;const i={encrypted:t},n=await http.post("/api/queue/decrypt-data",i,e.httpConfig);await e.fetchPatientRight(n.citizenId),e.setProfile(n),e.setLoading(!1),e.setLoadingMessage("กรุณาเสียบบัตรประชาชน"),e.right&&("15049"!==e.right.hmain||"WEL"!==e.right.maininscl&&"UCS"!==e.right.maininscl?"15049"===e.right.hmain||"WEL"!==e.right.maininscl&&"UCS"!==e.right.maininscl||Swal.fire({title:"คุณมี ใบส่งตัว/ใบ Refer มาพร้อมการรักษาวันนี้หรือไม่?",text:"",icon:"question",width:"60%",showCancelButton:!0,reverseButtons:!0,allowOutsideClick:!1,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"มี",cancelButtonText:"ไม่มี",didOpen:()=>{$(Swal.getTitle()).css("fontSize","5rem"),$(Swal.getTitle()).css("padding","0 1em 0"),$(Swal.getConfirmButton()).css("fontSize","2rem"),$(Swal.getConfirmButton()).css("width","200px"),$(Swal.getCancelButton()).css("fontSize","2rem"),$(Swal.getCancelButton()).css("width","200px"),$(Swal.getIcon()).css("fontSize","2rem")}}).then(t=>{t.isConfirmed?(Swal.fire({icon:"warning",title:"กรุณาติดต่อห้องเบอร์ 1",confirmButtonText:"ปิด",width:"60%",didOpen:()=>{$(Swal.getTitle()).css("fontSize","5rem"),$(Swal.getTitle()).css("padding","0 1em 0"),$(Swal.getConfirmButton()).css("fontSize","2rem"),$(Swal.getConfirmButton()).css("width","200px"),$(Swal.getIcon()).css("fontSize","2rem")}}),e.onCancelAction()):e.service_id="40"}):(e.service_id="38",Swal.close())),e.loading2=!1}catch(t){e.loading2=!1,e.setLoading(!1),e.setLoadingMessage("กรุณาเสียบบัตรประชาชน"),Swal.fire({icon:"error",title:"Oops...",text:t.message})}},fetchPatientRight:async function(t){try{const e=await http.get(`/api/queue/patient-right/${t}`,{baseURL:window.nodeBaseURLLocal});return this.setRight(_.get(e,"data")),e}catch(t){Swal.fire({icon:"error",title:"Oops...",text:t.message})}},onClickNumber(t){const e=this.search;e.length<13&&(this.search=e+t.toString(),setTimeout(()=>{this.$refs.search.focus()},0))},onClearSearch(){this.search="",setTimeout(()=>{this.$refs.search.focus()},0)},onDeleteNumber(){this.search&&(this.search=this.search.substr(0,this.search.length-1),setTimeout(()=>{this.$refs.search.focus()},0))},setProfile:function(t){this.patient=t},setRight:function(t){this.right=t},onConfirmSearch:async function(){const t=this;if(t.search)try{Swal.fire({title:"Please wait...",text:"กำลังตรวจสอบข้อมูล",timerProgressBar:!0,allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}}),await t.fetchPatientRight(t.search),t.right&&("15049"!==t.right.hmain||"WEL"!==t.right.maininscl&&"UCS"!==t.right.maininscl?"15049"===t.right.hmain||"WEL"!==t.right.maininscl&&"UCS"!==t.right.maininscl?Swal.close():Swal.fire({title:"คุณมี ใบส่งตัว/ใบ Refer มาพร้อมการรักษาวันนี้หรือไม่?",text:"",icon:"question",width:"60%",showCancelButton:!0,reverseButtons:!0,allowOutsideClick:!1,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"มี",cancelButtonText:"ไม่มี",didOpen:()=>{$(Swal.getTitle()).css("fontSize","5rem"),$(Swal.getTitle()).css("padding","0 1em 0"),$(Swal.getConfirmButton()).css("fontSize","2rem"),$(Swal.getConfirmButton()).css("width","200px"),$(Swal.getCancelButton()).css("fontSize","2rem"),$(Swal.getCancelButton()).css("width","200px"),$(Swal.getIcon()).css("fontSize","2rem")}}).then(e=>{e.isConfirmed?(Swal.fire({icon:"warning",title:"กรุณาติดต่อห้องเบอร์ 1",confirmButtonText:"ปิด",width:"60%",didOpen:()=>{$(Swal.getTitle()).css("fontSize","5rem"),$(Swal.getTitle()).css("padding","0 1em 0"),$(Swal.getConfirmButton()).css("fontSize","2rem"),$(Swal.getConfirmButton()).css("width","200px"),$(Swal.getIcon()).css("fontSize","2rem")}}),t.onCancelAction()):t.service_id="40"}):(t.service_id="38",Swal.close()))}catch(t){Swal.fire({icon:"error",title:"Oops...",text:t.message})}else Swal.fire({icon:"warning",title:"",text:"กรุณาป้อนหมายเลขบัตรประจำตัวประชาชนที่ต้องการทำรายการ"})},onSelectService:function(t){this.service_id=t},onCreateQueue:async function(t=!1){const e=this;if(e.service_id)try{Swal.fire({title:"กรุณารอสักครู่...",text:"ระบบกำลังทำรายการ",timerProgressBar:!0,allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const t={service_id:e.service_id,cid:e.cid,patient_name:e.getPatientname(),age:String(e.age),maininscl_name:e.rightName,picture:_.get(e.patient,"photo"),right:e.right},i=await http.post("/api/queue/create-queue",t,e.httpConfig);socket.emit("register",i),Swal.fire({icon:"success",title:"กรุณารอรับบัตรคิว",text:"",timer:3e3,showConfirmButton:!1}),e.onCancelAction(),window.open(`/queue/kiosk/print-ticket?id=${i.modelQueue.q_ids}`,"myPrint","width=800, height=600")}catch(t){Swal.fire({icon:"error",title:"Oops...",text:t.message})}else Swal.fire({icon:"warning",title:"กรุณาเลือกบริการ",text:""})},getPatientname:function(){if("scan-idcard"===this.action&&this.patient)return _.get(this.patient,"fullname","");if("hn-or-idcard"===this.action&&this.right){const t=_.get(this.right,"title_name",""),e=_.get(this.right,"fname",""),i=_.get(this.right,"lname","");return`${t}${e} ${i}`}return""},getRight:function(t,e=""){return _.get(this.right,t,e)}}});